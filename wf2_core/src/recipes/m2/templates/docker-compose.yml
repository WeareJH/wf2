#                                       #
#                                       #
# ------- DO NOT EDIT THIS FILE ------- #
#  It's auto generated and your changes #
#          will be overridden           #
#                                       #
#                                       #
version: '3.7'

# TODO: Add yarn/npm cache volume as external ...

volumes:
  db-data:
    name: wf2__${WF2_CONTEXT_NAME}__db-data
  app-src:
    name: wf2__${WF2_CONTEXT_NAME}__app-src
  composer-cache:
    name: wf2__${WF2_CONTEXT_NAME}__composer-cache

services:
  unison:
    container_name: wf2__${WF2_CONTEXT_NAME}__unison
    image: wearejh/unison
    volumes:
      - ${WF2_PWD}:/volumes/host
      - app-src:/volumes/internal
      - ${WF2_UNISON_FILE}:/home/docker/.unison/sync.prf
    env_file:
      - ${WF2_ENV_FILE}
    restart: unless-stopped
    labels:
      - "traefik.enable=false"

  traefik:
    container_name: wf2__${WF2_CONTEXT_NAME}__traefik
    image: traefik
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${WF2_TRAEFIK_FILE}:/etc/traefik/traefik.toml
    ports:
      - 80:80
      - 443:443
      - 8080:8080
    command: --api --docker
    labels:
      - "traefik.enable=false"

  # TODO: Varnish M2 image ?
  varnish:
    container_name: wf2__${WF2_CONTEXT_NAME}__varnish
    image: wearejh/magento-varnish:latest
    depends_on:
      - nginx
    labels:
      - traefik.frontend.rule=Host:${WF2_DOMAIN}

  nginx:
    container_name: wf2__${WF2_CONTEXT_NAME}__nginx
    image: wearejh/nginx:stable-m2
    volumes:
      - ${WF2_NGINX_FILE}:/etc/nginx/conf.d
      - app-src:/var/www
    working_dir: /var/www
    depends_on:
      - php
    env_file:
      - ${WF2_ENV_FILE}

  php:
    container_name: wf2__${WF2_CONTEXT_NAME}__php
    image: ${WF2_PHP_IMAGE}
    volumes:
      - app-src:/var/www
      - composer-cache:/home/www-data/.composer/cache
    depends_on:
      - db
    ports:
      - 9000
    env_file:
      - ${WF2_ENV_FILE}
    labels:
      - "traefik.enable=false"

  php-debug:
    container_name: wf2__${WF2_CONTEXT_NAME}__php_debug
    image: ${WF2_PHP_IMAGE}
    volumes:
      - app-src:/var/www
      - composer-cache:/home/www-data/.composer/cache
    depends_on:
      - db
    ports:
      - 9000
    environment:
      - XDEBUG_ENABLE=true
    env_file:
      - ${WF2_ENV_FILE}
    labels:
      - "traefik.enable=false"

  node:
    container_name: wf2__${WF2_CONTEXT_NAME}__node
    image: wearejh/node:8-m2
    working_dir: /var/www
    init: true
    volumes:
      - app-src:/var/www
    #            - npm-cache:/home/www-data/.npm # YARN / NPM cache dirs ?!?
    env_file:
      - ${WF2_ENV_FILE}
    labels:
      - "traefik.enable=false"

  db:
    container_name: wf2__${WF2_CONTEXT_NAME}__db
    image: mysql:5.6
    volumes:
      - db-data:/var/lib/mysql
    ports:
      - "3306:3306"
    restart: unless-stopped
    env_file:
      - ${WF2_ENV_FILE}
    labels:
      - "traefik.enable=false"

  redis:
    container_name: wf2__${WF2_CONTEXT_NAME}__redis
    image: redis:3-alpine
    ports:
      - "6379:6379"
    labels:
      - "traefik.enable=false"

  rabbitmq:
    image: rabbitmq:3.7-management-alpine
    env_file:
      - ${WF2_ENV_FILE}
    ports:
      - "15672:15672"
      - "5672:5672"
    labels:
      - "traefik.enable=false"

  mail:
    container_name: wf2__${WF2_CONTEXT_NAME}__mail
    image: mailhog/mailhog
    ports: # TODO: required?
      - 1025
    labels:
      - "traefik.frontend.rule=Host:mail.jh"
      - "traefik.port=8025"

  blackfire:
    container_name: wf2__${WF2_CONTEXT_NAME}__blackfire
    image: blackfire/blackfire
    env_file:
      - ${WF2_ENV_FILE}
    labels:
      - "traefik.enable=false"
